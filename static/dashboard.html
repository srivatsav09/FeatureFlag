<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature Flag Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            color: #333;
        }

        /* Sidebar */
        .sidebar {
            width: 220px;
            height: 100vh;
            background: #1a1d29;
            position: fixed;
            left: 0;
            top: 0;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
        }
        .sidebar-logo {
            color: #fff;
            font-size: 22px;
            font-weight: 700;
            padding: 0 24px 30px;
            border-bottom: 1px solid #2d3140;
        }
        .sidebar-logo span { color: #00d4aa; }
        .sidebar-nav { margin-top: 20px; }
        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            color: #8b8fa3;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
        }
        .sidebar-nav a:hover, .sidebar-nav a.active {
            color: #fff;
            background: #2d3140;
        }
        .sidebar-nav a.active { border-left: 3px solid #00d4aa; }

        /* Main content */
        .main { margin-left: 220px; padding: 30px; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .header h1 { font-size: 24px; color: #1a1d29; }

        /* Auth section */
        .auth-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .auth-bar .user-info {
            font-size: 13px;
            color: #666;
        }
        .auth-bar .user-info strong { color: #333; }
        .auth-bar .role-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .role-admin { background: #fee2e2; color: #dc2626; }
        .role-developer { background: #dbeafe; color: #2563eb; }
        .role-viewer { background: #e5e7eb; color: #6b7280; }

        /* Stats cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            text-align: center;
        }
        .stat-card .icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 22px;
        }
        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #1a1d29;
        }
        .stat-card .label {
            font-size: 12px;
            color: #8b8fa3;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }
        .icon-flags { background: #e0f2fe; color: #0284c7; }
        .icon-envs { background: #f0fdf4; color: #16a34a; }
        .icon-active { background: #fef3c7; color: #d97706; }
        .icon-rollouts { background: #ede9fe; color: #7c3aed; }

        /* Section */
        .section {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            margin-bottom: 24px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .section-header h2 { font-size: 16px; }

        /* Environment tabs */
        .env-tabs {
            display: flex;
            gap: 8px;
        }
        .env-tab {
            padding: 6px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
            color: #666;
            transition: all 0.2s;
        }
        .env-tab:hover { border-color: #00d4aa; color: #00d4aa; }
        .env-tab.active {
            background: #00d4aa;
            color: #fff;
            border-color: #00d4aa;
        }

        /* Table */
        table { width: 100%; border-collapse: collapse; }
        th {
            text-align: left;
            padding: 10px 12px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #8b8fa3;
            border-bottom: 1px solid #eee;
        }
        td {
            padding: 14px 12px;
            font-size: 14px;
            border-bottom: 1px solid #f5f5f5;
        }

        /* Toggle switch */
        .toggle {
            width: 44px;
            height: 24px;
            background: #d1d5db;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        .toggle.on { background: #00d4aa; }
        .toggle::after {
            content: '';
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }
        .toggle.on::after { left: 22px; }

        /* Badges */
        .badge {
            font-size: 12px;
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 500;
        }
        .badge-boolean { background: #dbeafe; color: #2563eb; }
        .badge-percentage { background: #ede9fe; color: #7c3aed; }
        .percentage-bar {
            width: 60px;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-right: 6px;
        }
        .percentage-bar-fill {
            height: 100%;
            background: #7c3aed;
            border-radius: 3px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #00d4aa;
            color: #fff;
        }
        .btn-primary:hover { background: #00b894; }
        .btn-danger { background: #fee2e2; color: #dc2626; }
        .btn-danger:hover { background: #fecaca; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }

        /* Evaluate tester */
        .eval-form {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .eval-form input, .eval-form select {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }
        .eval-form input:focus, .eval-form select:focus {
            border-color: #00d4aa;
        }
        .eval-result {
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
        .eval-result.on { display: block; background: #f0fdf4; color: #16a34a; }
        .eval-result.off { display: block; background: #fef2f2; color: #dc2626; }

        /* Audit log */
        .audit-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #f5f5f5;
            font-size: 14px;
        }
        .audit-action {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .action-created { background: #f0fdf4; color: #16a34a; }
        .action-updated { background: #fef3c7; color: #d97706; }
        .action-deleted { background: #fee2e2; color: #dc2626; }
        .audit-time { color: #8b8fa3; font-size: 12px; margin-left: auto; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: #fff;
            border-radius: 12px;
            padding: 28px;
            width: 440px;
            max-width: 90vw;
        }
        .modal h3 { margin-bottom: 20px; font-size: 18px; }
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: #00d4aa;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Login page */
        .login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #f0f2f5;
        }
        .login-box {
            background: #fff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 380px;
        }
        .login-box h2 {
            text-align: center;
            margin-bottom: 8px;
        }
        .login-box p {
            text-align: center;
            color: #8b8fa3;
            font-size: 14px;
            margin-bottom: 24px;
        }
        .login-box .form-group { margin-bottom: 16px; }
        .login-box .btn { width: 100%; padding: 12px; font-size: 15px; }
        .login-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .login-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            color: #8b8fa3;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .login-tab.active { color: #00d4aa; border-bottom-color: #00d4aa; }
        .error-msg { color: #dc2626; font-size: 13px; text-align: center; margin-top: 10px; }
        .hidden { display: none; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #8b8fa3;
        }
    </style>
</head>
<body>

<!-- Login Page -->
<div id="loginPage" class="login-page">
    <div class="login-box">
        <h2>Feature Flags</h2>
        <p>Sign in to manage your feature flags</p>
        <div class="login-tabs">
            <div class="login-tab active" onclick="showLoginTab('login')">Login</div>
            <div class="login-tab" onclick="showLoginTab('register')">Register</div>
        </div>
        <div id="loginForm">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="admin@test.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="password">
            </div>
            <button class="btn btn-primary" onclick="handleLogin()">Sign In</button>
        </div>
        <div id="registerForm" class="hidden">
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="regName" placeholder="Your name">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="regEmail" placeholder="user@example.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="regPassword" placeholder="Min 8 characters">
            </div>
            <button class="btn btn-primary" onclick="handleRegister()">Create Account</button>
        </div>
        <div id="authError" class="error-msg hidden"></div>
    </div>
</div>

<!-- Dashboard -->
<div id="dashboard" class="hidden">
    <div class="sidebar">
        <div class="sidebar-logo"><span>Flag</span>Control</div>
        <nav class="sidebar-nav">
            <a href="#" class="active" onclick="showSection('flags')">&#9873; Flags</a>
            <a href="#" onclick="showSection('evaluate')">&#9881; Evaluate</a>
            <a href="#" onclick="showSection('audit')">&#128203; Audit Log</a>
        </nav>
    </div>

    <div class="main">
        <div class="header">
            <h1>Dashboard</h1>
            <div class="auth-bar">
                <div class="user-info">
                    <strong id="userName"></strong>
                    <span id="userRole" class="role-badge"></span>
                </div>
                <button class="btn btn-sm btn-danger" onclick="handleLogout()">Logout</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <div class="icon icon-flags">&#127988;</div>
                <div class="value" id="statTotalFlags">0</div>
                <div class="label">Total Flags</div>
            </div>
            <div class="stat-card">
                <div class="icon icon-envs">&#127760;</div>
                <div class="value" id="statEnvs">0</div>
                <div class="label">Environments</div>
            </div>
            <div class="stat-card">
                <div class="icon icon-active">&#9889;</div>
                <div class="value" id="statActive">0</div>
                <div class="label">Active Flags</div>
            </div>
            <div class="stat-card">
                <div class="icon icon-rollouts">&#127922;</div>
                <div class="value" id="statRollouts">0</div>
                <div class="label">Rollouts</div>
            </div>
        </div>

        <!-- Flags Section -->
        <div id="flagsSection" class="section">
            <div class="section-header">
                <h2>Feature Flags</h2>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div class="env-tabs" id="envTabs"></div>
                    <button class="btn btn-primary" onclick="showCreateFlagModal()">+ New Flag</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Flag Key</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Rollout</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="flagsTable"></tbody>
            </table>
            <div id="flagsEmpty" class="empty-state hidden">No flags in this environment</div>
        </div>

        <!-- Evaluate Section -->
        <div id="evaluateSection" class="section hidden">
            <div class="section-header">
                <h2>Flag Evaluator</h2>
            </div>
            <p style="color: #8b8fa3; font-size: 14px; margin-bottom: 16px;">
                Test how a flag evaluates for a specific user.
            </p>
            <div class="eval-form">
                <select id="evalFlag">
                    <option value="">Select flag...</option>
                </select>
                <select id="evalEnv">
                    <option value="">Select environment...</option>
                </select>
                <input type="text" id="evalUser" placeholder="User ID (e.g. alice)">
                <button class="btn btn-primary" onclick="evaluateFlag()">Evaluate</button>
            </div>
            <div id="evalResult" class="eval-result"></div>
        </div>

        <!-- Audit Section -->
        <div id="auditSection" class="section hidden">
            <div class="section-header">
                <h2>Recent Audit Logs</h2>
            </div>
            <div id="auditList"></div>
            <div id="auditEmpty" class="empty-state hidden">No audit logs yet</div>
        </div>
    </div>
</div>

<!-- Create/Edit Flag Modal -->
<div class="modal-overlay" id="flagModal">
    <div class="modal">
        <h3 id="modalTitle">New Flag</h3>
        <div class="form-group">
            <label>Key (lowercase, hyphens only)</label>
            <input type="text" id="flagKey" placeholder="new-checkout">
        </div>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="flagName" placeholder="New Checkout Flow">
        </div>
        <div class="form-group">
            <label>Type</label>
            <select id="flagType">
                <option value="boolean">Boolean (ON/OFF)</option>
                <option value="percentage">Percentage Rollout</option>
            </select>
        </div>
        <div class="form-group" id="rolloutGroup">
            <label>Rollout Percentage</label>
            <input type="number" id="flagRollout" min="0" max="100" value="0" placeholder="0-100">
        </div>
        <div class="form-group">
            <label>Environment</label>
            <select id="flagEnvSelect"></select>
        </div>
        <div class="modal-actions">
            <button class="btn" onclick="closeFlagModal()" style="background:#f5f5f5;">Cancel</button>
            <button class="btn btn-primary" id="modalSaveBtn" onclick="saveFlag()">Create</button>
        </div>
    </div>
</div>

<script>
    const API = '';  // same origin
    let token = localStorage.getItem('ff_token');
    let currentUser = JSON.parse(localStorage.getItem('ff_user') || 'null');
    let environments = [];
    let currentEnv = 'development';
    let allFlags = [];
    let editingFlag = null;

    // ==================== Auth ====================
    function headers() {
        return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
        };
    }

    async function handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        try {
            const res = await fetch(`${API}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password }),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || 'Login failed');
            token = data.access_token;
            currentUser = data.user;
            localStorage.setItem('ff_token', token);
            localStorage.setItem('ff_user', JSON.stringify(currentUser));
            showDashboard();
        } catch (err) {
            showError(err.message);
        }
    }

    async function handleRegister() {
        const name = document.getElementById('regName').value;
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPassword').value;
        try {
            const res = await fetch(`${API}/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password, name }),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || 'Registration failed');
            token = data.access_token;
            currentUser = data.user;
            localStorage.setItem('ff_token', token);
            localStorage.setItem('ff_user', JSON.stringify(currentUser));
            showDashboard();
        } catch (err) {
            showError(err.message);
        }
    }

    function handleLogout() {
        token = null;
        currentUser = null;
        localStorage.removeItem('ff_token');
        localStorage.removeItem('ff_user');
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('loginPage').style.display = 'flex';
    }

    function showLoginTab(tab) {
        document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
        document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
        document.getElementById('authError').classList.add('hidden');
    }

    function showError(msg) {
        const el = document.getElementById('authError');
        el.textContent = msg;
        el.classList.remove('hidden');
    }

    // ==================== Dashboard ====================
    async function showDashboard() {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('userName').textContent = currentUser.name;
        const roleEl = document.getElementById('userRole');
        roleEl.textContent = currentUser.role;
        roleEl.className = `role-badge role-${currentUser.role}`;

        await loadEnvironments();
        await loadFlags();
        loadAuditLogs();
    }

    function showSection(section) {
        document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('flagsSection').classList.toggle('hidden', section !== 'flags');
        document.getElementById('evaluateSection').classList.toggle('hidden', section !== 'evaluate');
        document.getElementById('auditSection').classList.toggle('hidden', section !== 'audit');
        if (section === 'evaluate') loadEvalDropdowns();
        if (section === 'audit') loadAuditLogs();
    }

    // ==================== Environments ====================
    async function loadEnvironments() {
        try {
            const res = await fetch(`${API}/environments`, { headers: headers() });
            if (res.status === 401) { handleLogout(); return; }
            environments = await res.json();
            renderEnvTabs();
        } catch (err) {
            console.error('Failed to load environments:', err);
        }
    }

    function renderEnvTabs() {
        const container = document.getElementById('envTabs');
        container.innerHTML = environments.map(env =>
            `<div class="env-tab ${env.key === currentEnv ? 'active' : ''}"
                  onclick="switchEnv('${env.key}')">${env.name}</div>`
        ).join('');
    }

    function switchEnv(envKey) {
        currentEnv = envKey;
        renderEnvTabs();
        renderFlags();
    }

    // ==================== Flags ====================
    async function loadFlags() {
        try {
            const res = await fetch(`${API}/flags`, { headers: headers() });
            allFlags = await res.json();
            renderFlags();
            updateStats();
        } catch (err) {
            console.error('Failed to load flags:', err);
        }
    }

    function renderFlags() {
        const envObj = environments.find(e => e.key === currentEnv);
        const flags = allFlags.filter(f => f.environment_id === (envObj ? envObj.id : ''));
        const tbody = document.getElementById('flagsTable');
        const empty = document.getElementById('flagsEmpty');

        if (flags.length === 0) {
            tbody.innerHTML = '';
            empty.classList.remove('hidden');
            return;
        }
        empty.classList.add('hidden');

        tbody.innerHTML = flags.map(flag => `
            <tr>
                <td><strong>${flag.key}</strong></td>
                <td>${flag.name}</td>
                <td><span class="badge badge-${flag.flag_type}">${flag.flag_type}</span></td>
                <td>
                    ${flag.flag_type === 'percentage' ? `
                        <div class="percentage-bar">
                            <div class="percentage-bar-fill" style="width:${flag.rollout_percentage}%"></div>
                        </div>
                        ${flag.rollout_percentage}%
                    ` : '-'}
                </td>
                <td>
                    <div class="toggle ${flag.is_enabled ? 'on' : ''}"
                         onclick="toggleFlag('${flag.key}', ${!flag.is_enabled})"></div>
                </td>
                <td>
                    <button class="btn-icon" title="Edit" onclick='editFlag(${JSON.stringify(flag)})'>&#9998;</button>
                    <button class="btn-icon" title="Delete" onclick="deleteFlag('${flag.key}')" style="color:#dc2626;">&#128465;</button>
                </td>
            </tr>
        `).join('');
    }

    function updateStats() {
        const active = allFlags.filter(f => f.is_enabled).length;
        const rollouts = allFlags.filter(f => f.flag_type === 'percentage' && f.is_enabled).length;
        document.getElementById('statTotalFlags').textContent = allFlags.length;
        document.getElementById('statEnvs').textContent = environments.length;
        document.getElementById('statActive').textContent = active;
        document.getElementById('statRollouts').textContent = rollouts;
    }

    async function toggleFlag(flagKey, newState) {
        try {
            await fetch(`${API}/flags/${flagKey}?environment_key=${currentEnv}`, {
                method: 'PUT',
                headers: headers(),
                body: JSON.stringify({ is_enabled: newState }),
            });
            await loadFlags();
        } catch (err) {
            alert('Failed to toggle flag: ' + err.message);
        }
    }

    async function deleteFlag(flagKey) {
        if (!confirm(`Delete flag "${flagKey}" from ${currentEnv}?`)) return;
        try {
            await fetch(`${API}/flags/${flagKey}?environment_key=${currentEnv}`, {
                method: 'DELETE',
                headers: headers(),
            });
            await loadFlags();
        } catch (err) {
            alert('Failed to delete flag: ' + err.message);
        }
    }

    // ==================== Create/Edit Flag Modal ====================
    function showCreateFlagModal() {
        editingFlag = null;
        document.getElementById('modalTitle').textContent = 'New Flag';
        document.getElementById('modalSaveBtn').textContent = 'Create';
        document.getElementById('flagKey').value = '';
        document.getElementById('flagKey').disabled = false;
        document.getElementById('flagName').value = '';
        document.getElementById('flagType').value = 'boolean';
        document.getElementById('flagRollout').value = 0;
        populateEnvSelect();
        document.getElementById('flagModal').classList.add('show');
    }

    function editFlag(flag) {
        editingFlag = flag;
        document.getElementById('modalTitle').textContent = 'Edit Flag';
        document.getElementById('modalSaveBtn').textContent = 'Update';
        document.getElementById('flagKey').value = flag.key;
        document.getElementById('flagKey').disabled = true;
        document.getElementById('flagName').value = flag.name;
        document.getElementById('flagType').value = flag.flag_type;
        document.getElementById('flagRollout').value = flag.rollout_percentage;
        populateEnvSelect();
        document.getElementById('flagModal').classList.add('show');
    }

    function closeFlagModal() {
        document.getElementById('flagModal').classList.remove('show');
        editingFlag = null;
    }

    function populateEnvSelect() {
        const select = document.getElementById('flagEnvSelect');
        select.innerHTML = environments.map(env =>
            `<option value="${env.id}" ${env.key === currentEnv ? 'selected' : ''}>${env.name}</option>`
        ).join('');
    }

    async function saveFlag() {
        if (editingFlag) {
            // Update
            try {
                await fetch(`${API}/flags/${editingFlag.key}?environment_key=${currentEnv}`, {
                    method: 'PUT',
                    headers: headers(),
                    body: JSON.stringify({
                        name: document.getElementById('flagName').value,
                        flag_type: document.getElementById('flagType').value,
                        rollout_percentage: parseInt(document.getElementById('flagRollout').value),
                    }),
                });
                closeFlagModal();
                await loadFlags();
            } catch (err) {
                alert('Failed to update flag: ' + err.message);
            }
        } else {
            // Create
            try {
                const res = await fetch(`${API}/flags`, {
                    method: 'POST',
                    headers: headers(),
                    body: JSON.stringify({
                        key: document.getElementById('flagKey').value,
                        name: document.getElementById('flagName').value,
                        flag_type: document.getElementById('flagType').value,
                        rollout_percentage: parseInt(document.getElementById('flagRollout').value),
                        environment_id: document.getElementById('flagEnvSelect').value,
                    }),
                });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.detail);
                }
                closeFlagModal();
                await loadFlags();
            } catch (err) {
                alert('Failed to create flag: ' + err.message);
            }
        }
    }

    // ==================== Evaluate ====================
    function loadEvalDropdowns() {
        const flagSelect = document.getElementById('evalFlag');
        const envSelect = document.getElementById('evalEnv');
        const uniqueKeys = [...new Set(allFlags.map(f => f.key))];
        flagSelect.innerHTML = '<option value="">Select flag...</option>' +
            uniqueKeys.map(k => `<option value="${k}">${k}</option>`).join('');
        envSelect.innerHTML = '<option value="">Select environment...</option>' +
            environments.map(e => `<option value="${e.key}">${e.name}</option>`).join('');
    }

    async function evaluateFlag() {
        const flagKey = document.getElementById('evalFlag').value;
        const envKey = document.getElementById('evalEnv').value;
        const userId = document.getElementById('evalUser').value;
        if (!flagKey || !envKey) { alert('Select a flag and environment'); return; }

        try {
            let url = `${API}/evaluate/${flagKey}?environment_key=${envKey}`;
            if (userId) url += `&user_id=${userId}`;

            const res = await fetch(url);
            const data = await res.json();
            const el = document.getElementById('evalResult');
            el.className = `eval-result ${data.enabled ? 'on' : 'off'}`;
            el.innerHTML = `
                <strong>${data.enabled ? 'ENABLED' : 'DISABLED'}</strong>
                &mdash; ${data.reason}
                ${data.cached !== undefined ? `<br><small style="opacity:0.7">Cache: ${data.cached ? 'HIT' : 'MISS'}</small>` : ''}
            `;
        } catch (err) {
            alert('Evaluation failed: ' + err.message);
        }
    }

    // ==================== Audit Logs ====================
    async function loadAuditLogs() {
        try {
            const res = await fetch(`${API}/audit/?limit=20`, { headers: headers() });
            if (!res.ok) return;
            const logs = await res.json();
            const container = document.getElementById('auditList');
            const empty = document.getElementById('auditEmpty');

            if (logs.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            container.innerHTML = logs.map(log => {
                const time = new Date(log.created_at).toLocaleString();
                let changesHtml = '';
                if (log.changes) {
                    try {
                        const changes = JSON.parse(log.changes);
                        changesHtml = Object.entries(changes).map(([field, vals]) =>
                            `<span style="color:#8b8fa3; font-size:12px;">${field}: ${vals.old} &rarr; ${vals.new}</span>`
                        ).join(', ');
                    } catch(e) {}
                }
                return `
                    <div class="audit-item">
                        <span class="audit-action action-${log.action}">${log.action}</span>
                        <strong>${log.entity_key}</strong>
                        <span style="color:#8b8fa3">${log.environment_key || ''}</span>
                        ${changesHtml ? `<span style="color:#8b8fa3; font-size:12px;">${changesHtml}</span>` : ''}
                        <span class="audit-time">${time}</span>
                    </div>
                `;
            }).join('');
        } catch (err) {
            console.error('Failed to load audit logs:', err);
        }
    }

    // ==================== Init ====================
    if (token && currentUser) {
        showDashboard();
    }
</script>

</body>
</html>
